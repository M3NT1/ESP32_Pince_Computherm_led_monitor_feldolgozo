<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM LED Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #e0e0e0;
        }
        
        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            background: #f9f9f9;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.danger {
            background: linear-gradient(135deg, #f85032 0%, #e73827 100%);
        }
        
        button.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
            border: 3px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        #imageCanvas {
            display: block;
            cursor: crosshair;
            max-width: 100%;
        }
        
        .zones-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .zone-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            transition: all 0.3s;
            position: relative;
        }
        
        .zone-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .zone-card.active {
            border-color: #38ef7d;
            background: #f0fff4;
        }
        
        .zone-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .zone-info {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .status-indicator.on {
            background: #38ef7d;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.off {
            background: #f85032;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .monitor-status {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .monitor-status h3 {
            margin: 0;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 5px solid #17a2b8;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        
        #drawInstruction {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #ffc107;
            display: none;
        }
        
        .delete-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            font-size: 0.8em;
            background: #f85032;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .mqtt-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        
        .mqtt-status.connected {
            background: #38ef7d;
            color: #155724;
        }
        
        .mqtt-status.disconnected {
            background: #f85032;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¥ ESP32-CAM LED Monitor</h1>
            <p>Computherm f≈±t√©sszab√°lyoz√≥ LED √°llapotfigyel≈ë rendszer</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('setup')">‚öôÔ∏è Be√°ll√≠t√°s</div>
            <div class="tab" onclick="showTab('zones')">üìç Z√≥n√°k</div>
            <div class="tab" onclick="showTab('monitor')">üìä Monitoring</div>
        </div>
        
        <!-- BE√ÅLL√çT√ÅS TAB -->
        <div id="setup" class="tab-content active">
            <div class="section">
                <h2>Alapbe√°ll√≠t√°sok</h2>
                
                <div class="form-group">
                    <label>ESP32-CAM IP c√≠m:</label>
                    <input type="text" id="esp32_url" placeholder="http://192.168.1.100" value="http://192.168.1.100">
                </div>
                
                <div class="form-group">
                    <label>MQTT Broker:</label>
                    <input type="text" id="mqtt_broker" placeholder="localhost" value="localhost">
                </div>
                
                <div class="form-group">
                    <label>MQTT Port:</label>
                    <input type="number" id="mqtt_port" value="1883">
                </div>
                
                <div class="form-group">
                    <label>MQTT Felhaszn√°l√≥ (opcion√°lis):</label>
                    <input type="text" id="mqtt_user" placeholder="">
                </div>
                
                <div class="form-group">
                    <label>MQTT Jelsz√≥ (opcion√°lis):</label>
                    <input type="password" id="mqtt_password" placeholder="">
                </div>
                
                <button onclick="saveConfig()">üíæ Konfigur√°ci√≥ ment√©se</button>
            </div>
        </div>
        
        <!-- Z√ìN√ÅK TAB -->
        <div id="zones" class="tab-content">
            <div class="section">
                <h2>LED Z√≥n√°k kijel√∂l√©se</h2>
                
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è √ötmutat√≥:</strong> Kattints a "K√©p bet√∂lt√©se" gombra, majd jel√∂ld ki az eg√©rrel a LED ter√ºleteket. Minden z√≥n√°t nevezz el!
                </div>
                
                <button onclick="loadSnapshot()">üì∑ K√©p bet√∂lt√©se</button>
                <button onclick="clearZones()" class="danger">üóëÔ∏è √ñsszes z√≥na t√∂rl√©se</button>
                <button onclick="saveZones()" class="success">üíæ Z√≥n√°k ment√©se</button>
                <button onclick="exportZones()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">üì• Export</button>
                <button onclick="importZones()" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">üìÇ Import</button>
                <button id="toggleAnnotationsZones" onclick="toggleAnnotations('zones')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">üëÅÔ∏è Kijel√∂l√©sek elrejt√©se</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                
                <div id="drawInstruction">
                    H√∫zz egy t√©glalapot a LED ter√ºletre az eg√©r lenyom√°s√°val √©s h√∫z√°s√°val!
                </div>
                
                <div class="canvas-container">
                    <canvas id="imageCanvas"></canvas>
                </div>
                
                <div id="zonesList" class="zones-list"></div>
            </div>
        </div>
        
        <!-- MONITORING TAB -->
        <div id="monitor" class="tab-content">
            <div class="monitor-status">
                <div>
                    <h3>üéØ Monitoring √°llapot</h3>
                    <p id="monitorStatus">Le√°ll√≠tva</p>
                </div>
                <div class="btn-group">
                    <button onclick="startMonitoring()" class="success">‚ñ∂Ô∏è Ind√≠t√°s</button>
                    <button onclick="stopMonitoring()" class="danger">‚èπÔ∏è Le√°ll√≠t√°s</button>
                    <button onclick="refreshStates()">üîÑ Friss√≠t√©s</button>
                    <button id="toggleAnnotationsMonitor" onclick="toggleAnnotations('monitor')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">üëÅÔ∏è Kijel√∂l√©sek elrejt√©se</button>
                </div>
            </div>
            
            <div class="section">
                <h2>√âl≈ë k√©p <span class="mqtt-status" id="mqttStatus">Ellen≈ërz√©s...</span></h2>
                <img id="liveImage" src="/api/annotated_snapshot" style="max-width: 100%; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
            </div>
            
            <div class="section">
                <h2>LED √Ållapotok</h2>
                <div id="statesDisplay" class="zones-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        let canvas, ctx, img;
        let zones = [];
        let isDrawing = false;
        let startX, startY;
        let currentZone = null;
        let monitoringInterval = null;
        let editingZoneIndex = null;  // Szerkeszt√©s m√≥d
        let showAnnotations = true;  // Kijel√∂l√©sek l√°that√≥s√°ga
        
        // Inicializ√°l√°s
        window.onload = function() {
            canvas = document.getElementById('imageCanvas');
            ctx = canvas.getContext('2d');
            loadConfig();
            loadZones();
            
            // Canvas esem√©nyek
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDrawing);
        };
        
        function showTab(tabName) {
            // Tab aktiv√°l√°s
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Ha monitoring tab, ind√≠tsuk az √©l≈ë k√©pet
            if (tabName === 'monitor') {
                refreshStates();
                if (!monitoringInterval) {
                    monitoringInterval = setInterval(() => {
                        const endpoint = showAnnotations ? '/api/annotated_snapshot' : '/api/snapshot';
                        document.getElementById('liveImage').src = endpoint + '?' + new Date().getTime();
                        refreshStates();
                    }, 2000);
                }
            } else {
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                }
            }
        }
        
        function toggleAnnotations(context) {
            showAnnotations = !showAnnotations;
            const btnZones = document.getElementById('toggleAnnotationsZones');
            const btnMonitor = document.getElementById('toggleAnnotationsMonitor');
            
            if (showAnnotations) {
                if (btnZones) btnZones.innerHTML = 'üëÅÔ∏è Kijel√∂l√©sek elrejt√©se';
                if (btnMonitor) btnMonitor.innerHTML = 'üëÅÔ∏è Kijel√∂l√©sek elrejt√©se';
            } else {
                if (btnZones) btnZones.innerHTML = 'üëÅÔ∏è Kijel√∂l√©sek megjelen√≠t√©se';
                if (btnMonitor) btnMonitor.innerHTML = 'üëÅÔ∏è Kijel√∂l√©sek megjelen√≠t√©se';
            }
            
            // Friss√≠tj√ºk a k√©pet az aktu√°lis kontextusban
            if (context === 'zones' && img) {
                redrawCanvas();
            } else if (context === 'monitor') {
                // Monitor eset√©n az √©l≈ë k√©p automatikusan friss√ºl a k√∂vetkez≈ë interval-n√°l
                // De azonnal friss√≠tj√ºk:
                const endpoint = showAnnotations ? '/api/annotated_snapshot' : '/api/snapshot';
                document.getElementById('liveImage').src = endpoint + '?' + new Date().getTime();
            }
        }
        
        // Konfigur√°ci√≥
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('esp32_url').value = config.esp32_cam_url;
                document.getElementById('mqtt_broker').value = config.mqtt_broker;
                document.getElementById('mqtt_port').value = config.mqtt_port;
                
                updateMonitorStatus(config.monitoring_active);
            } catch (error) {
                console.error('Konfigur√°ci√≥ bet√∂lt√©si hiba:', error);
            }
        }
        
        async function saveConfig() {
            const config = {
                esp32_cam_url: document.getElementById('esp32_url').value,
                mqtt_broker: document.getElementById('mqtt_broker').value,
                mqtt_port: parseInt(document.getElementById('mqtt_port').value),
                mqtt_user: document.getElementById('mqtt_user').value,
                mqtt_password: document.getElementById('mqtt_password').value
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    alert('‚úÖ Konfigur√°ci√≥ mentve!');
                }
            } catch (error) {
                alert('‚ùå Hiba a ment√©s sor√°n: ' + error);
            }
        }
        
        // Z√≥n√°k
        async function loadZones() {
            try {
                const response = await fetch('/api/zones');
                zones = await response.json();
                renderZones();
            } catch (error) {
                console.error('Z√≥n√°k bet√∂lt√©si hiba:', error);
            }
        }
        
        async function saveZones() {
            try {
                const response = await fetch('/api/zones', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(zones)
                });
                
                if (response.ok) {
                    alert('‚úÖ Z√≥n√°k mentve!');
                }
            } catch (error) {
                alert('‚ùå Hiba a ment√©s sor√°n: ' + error);
            }
        }
        
        async function exportZones() {
            try {
                if (zones.length === 0) {
                    alert('‚ö†Ô∏è Nincsenek export√°lhat√≥ z√≥n√°k!');
                    return;
                }
                
                // Let√∂lt√©s kezdem√©nyez√©se
                window.location.href = '/api/zones/export';
                
                setTimeout(() => {
                    alert('‚úÖ Z√≥n√°k export√°lva! A f√°jl let√∂lt√©se megkezd≈ëd√∂tt.');
                }, 500);
            } catch (error) {
                alert('‚ùå Hiba az export√°l√°s sor√°n: ' + error);
            }
        }
        
        function importZones() {
            // File picker aktiv√°l√°sa
            document.getElementById('importFileInput').click();
        }
        
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Ellen≈ërizz√ºk hogy JSON f√°jl-e
            if (!file.name.endsWith('.json')) {
                alert('‚ùå Csak .json f√°jlok t√°mogatottak!');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/zones/import', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Z√≥n√°k friss√≠t√©se
                    zones = data.zones;
                    renderZones();
                    redrawCanvas();
                    alert(`‚úÖ ${data.message}`);
                } else {
                    alert(`‚ùå Import hiba: ${data.error}`);
                }
            } catch (error) {
                alert('‚ùå Hiba az import√°l√°s sor√°n: ' + error);
            }
            
            // Input mez≈ë tiszt√≠t√°sa (hogy ugyanazt a f√°jlt is lehessen √∫jra import√°lni)
            event.target.value = '';
        }
        
        function clearZones() {
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d az √∂sszes z√≥n√°t?')) {
                zones = [];
                renderZones();
                redrawCanvas();
            }
        }
        
        async function loadSnapshot() {
            try {
                const endpoint = showAnnotations ? '/api/annotated_snapshot' : '/api/snapshot';
                const response = await fetch(endpoint);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    redrawCanvas();
                    document.getElementById('drawInstruction').style.display = 'block';
                };
                img.src = url;
            } catch (error) {
                alert('‚ùå K√©p bet√∂lt√©si hiba: ' + error);
            }
        }
        
        function startDrawing(e) {
            if (!img) return;
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
        }
        
        function draw(e) {
            if (!isDrawing || !img) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            redrawCanvas();
            
            // Jelenlegi rajzol√°s
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
        }
        
        function endDrawing(e) {
            if (!isDrawing || !img) return;
            isDrawing = false;
            
            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;
            
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);
            
            if (width > 10 && height > 10) {
                // Szerkeszt√©si m√≥d ellen≈ërz√©se
                if (editingZoneIndex !== null) {
                    // Szerkeszt√©si m√≥d: megl√©v≈ë z√≥na friss√≠t√©se
                    const existingZone = zones[editingZoneIndex];
                    
                    // Opcion√°lis: k√ºsz√∂b √©s LED t√≠pus m√≥dos√≠t√°sa
                    const updateParams = confirm('Szeretn√©d m√≥dos√≠tani a k√ºsz√∂b√©rt√©ket √©s LED t√≠pust is?');
                    
                    let threshold = existingZone.threshold;
                    let ledType = existingZone.led_type;
                    
                    if (updateParams) {
                        // K√ºsz√∂b√©rt√©k m√≥dos√≠t√°sa
                        let thresholdInput = prompt(`F√©nyer≈ë k√ºsz√∂b (10-100, jelenlegi: ${existingZone.threshold}):`, existingZone.threshold);
                        threshold = parseInt(thresholdInput) || existingZone.threshold;
                        threshold = Math.max(10, Math.min(100, threshold));
                        
                        // LED t√≠pus m√≥dos√≠t√°sa
                        const ledTypes = {
                            '1': 'auto',
                            '2': 'red',
                            '3': 'white',
                            '4': 'green',
                            '5': 'blue',
                            '6': 'orange',
                            '7': 'any'
                        };
                        const currentLedType = Object.keys(ledTypes).find(key => ledTypes[key] === existingZone.led_type) || '1';
                        const ledChoice = prompt(
                            'LED t√≠pus:\\n' +
                            '1 - Automatikus (v√∂r√∂s/feh√©r/narancs)\\n' +
                            '2 - Csak v√∂r√∂s\\n' +
                            '3 - Csak feh√©r\\n' +
                            '4 - Csak z√∂ld\\n' +
                            '5 - Csak k√©k\\n' +
                            '6 - Narancs/s√°rga\\n' +
                            '7 - B√°rmelyik sz√≠n\\n' +
                            `V√°lassz (1-7, jelenlegi: ${currentLedType}):`, currentLedType
                        );
                        ledType = ledTypes[ledChoice] || existingZone.led_type;
                    }
                    
                    // Z√≥na friss√≠t√©se (ID meg≈ërz√©s√©vel!)
                    zones[editingZoneIndex] = {
                        id: existingZone.id,  // KRITIKUS: eredeti ID megtart√°sa!
                        name: existingZone.name,
                        x: Math.min(startX, endX),
                        y: Math.min(startY, endY),
                        width: width,
                        height: height,
                        threshold: threshold,
                        led_type: ledType
                    };
                    
                    // Szerkeszt√©si m√≥d kikapcsol√°sa
                    editingZoneIndex = null;
                    
                    // Utas√≠t√°s elt√ºntet√©se
                    const instruction = document.getElementById('drawInstruction');
                    instruction.style.display = 'none';
                    
                    alert('‚úÖ Z√≥na friss√≠tve! Ne felejtsd el menteni a v√°ltoztat√°sokat!');
                } else {
                    // √öj z√≥na hozz√°ad√°sa
                    const zoneName = prompt('Add meg a z√≥na nev√©t (pl: Nappali, H√°l√≥):');
                    if (zoneName) {
                        // K√ºsz√∂b√©rt√©k bek√©r√©se
                        let threshold = prompt('F√©nyer≈ë k√ºsz√∂b (10-100, alap√©rtelmezett: 30):', '30');
                        threshold = parseInt(threshold) || 30;
                        threshold = Math.max(10, Math.min(100, threshold)); // 10-100 k√∂z√∂tt
                        
                        // LED t√≠pus bek√©r√©se
                        const ledTypes = {
                            '1': 'auto',
                            '2': 'red',
                            '3': 'white',
                            '4': 'green',
                            '5': 'blue',
                            '6': 'orange',
                            '7': 'any'
                        };
                        const ledChoice = prompt(
                            'LED t√≠pus:\\n' +
                            '1 - Automatikus (v√∂r√∂s/feh√©r/narancs)\\n' +
                            '2 - Csak v√∂r√∂s\\n' +
                            '3 - Csak feh√©r\\n' +
                            '4 - Csak z√∂ld\\n' +
                            '5 - Csak k√©k\\n' +
                            '6 - Narancs/s√°rga\\n' +
                            '7 - B√°rmelyik sz√≠n\\n' +
                            'V√°lassz (1-7, alap√©rtelmezett: 1):', '1'
                        );
                        const ledType = ledTypes[ledChoice] || 'auto';
                        
                        const zone = {
                            id: 'zone_' + Date.now(),
                            name: zoneName,
                            x: Math.min(startX, endX),
                            y: Math.min(startY, endY),
                            width: width,
                            height: height,
                            threshold: threshold,
                            led_type: ledType
                        };
                        zones.push(zone);
                    }
                }
                renderZones();
                redrawCanvas();
            }
        }
        
        function redrawCanvas(highlightIndex) {
            if (!img) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            // Z√≥n√°k rajzol√°sa csak ha showAnnotations igaz
            if (!showAnnotations) return;
            
            zones.forEach((zone, index) => {
                // Ha ez a szerkesztend≈ë z√≥na, kiemelt st√≠lussal rajzoljuk
                if (highlightIndex === index) {
                    ctx.strokeStyle = '#ff9800';
                    ctx.lineWidth = 4;
                    ctx.setLineDash([10, 5]); // Szaggatott vonal
                } else {
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([]); // Folytonos vonal
                }
                
                ctx.strokeRect(zone.x, zone.y, zone.width, zone.height);
                
                // Sz√∂veg st√≠lus
                if (highlightIndex === index) {
                    ctx.fillStyle = '#ff9800';
                    ctx.font = 'bold 18px Arial';
                } else {
                    ctx.fillStyle = '#ff0000';
                    ctx.font = '16px Arial';
                }
                
                ctx.fillText(`${index + 1}. ${zone.name}`, zone.x, zone.y - 5);
                ctx.setLineDash([]); // Reset
            });
        }
        
        function renderZones() {
            const list = document.getElementById('zonesList');
            list.innerHTML = '';
            
            zones.forEach((zone, index) => {
                const ledTypeNames = {
                    'auto': 'üî¥ Auto (v√∂r√∂s/feh√©r)',
                    'red': 'üî¥ V√∂r√∂s',
                    'white': '‚ö™ Feh√©r',
                    'green': 'üü¢ Z√∂ld',
                    'blue': 'üîµ K√©k',
                    'orange': 'üü† Narancs',
                    'any': 'üåà B√°rmely'
                };
                
                const card = document.createElement('div');
                card.className = 'zone-card';
                card.innerHTML = `
                    <h3>${index + 1}. ${zone.name}</h3>
                    <div class="zone-info">üìê M√©ret: ${zone.width} √ó ${zone.height}px</div>
                    <div class="zone-info">üìç Poz√≠ci√≥: (${zone.x}, ${zone.y})</div>
                    <div class="zone-info">üí° LED t√≠pus: ${ledTypeNames[zone.led_type] || ledTypeNames['auto']}</div>
                    <div class="zone-info">
                        üéöÔ∏è K√ºsz√∂b: 
                        <input type="number" value="${zone.threshold}" min="10" max="100"
                            onchange="zones[${index}].threshold = parseInt(this.value)" 
                            style="width: 60px;">
                    </div>
                    <div class="zone-info">üí° F√©nyer≈ë: <strong>${zone.last_brightness ? zone.last_brightness.toFixed(1) : 'N/A'}</strong></div>
                    <div class="zone-info">‚ö° √Ållapot: <strong>${zone.last_state ? 'üü¢ BE' : 'üî¥ KI'}</strong></div>
                    <button onclick="editZone(${index})" style="position: absolute; bottom: 10px; left: 10px; padding: 5px 10px; font-size: 0.8em; background: #ff9800;">‚úèÔ∏è Szerkeszt</button>
                    <button class="delete-btn" onclick="deleteZone(${index})">üóëÔ∏è T√∂rl√©s</button>
                `;
                list.appendChild(card);
            });
        }
        
        function deleteZone(index) {
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d ezt a z√≥n√°t?')) {
                zones.splice(index, 1);
                renderZones();
                redrawCanvas();
            }
        }
        
        function editZone(index) {
            if (!img) {
                alert('‚ö†Ô∏è El≈ësz√∂r t√∂ltsd be a k√©pet!');
                return;
            }
            
            // Aktiv√°ljuk a Z√≥n√°k tabot
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('zones').classList.add('active');
            
            editingZoneIndex = index;
            const zone = zones[index];
            
            // Ut√°n√°lat inform√°ci√≥
            const ledTypeNames = {
                'auto': 'Automatikus',
                'red': 'V√∂r√∂s',
                'white': 'Feh√©r',
                'green': 'Z√∂ld',
                'blue': 'K√©k',
                'orange': 'Narancs',
                'any': 'B√°rmely'
            };
            
            alert(`üìù Szerkeszt√©si m√≥d aktiv√°lva!\n\nZ√≥na: ${zone.name}\nLED t√≠pus: ${ledTypeNames[zone.led_type]}\nK√ºsz√∂b: ${zone.threshold}\n\nRajzolj egy √∫j ter√ºletet a LED-hez!`);
            
            // Canvas friss√≠t√©s √∫s jel√∂l√©ssel
            redrawCanvas(index);
            
            // Kiemelt √ºzenet megjelen√≠t√©se
            const instruction = document.getElementById('drawInstruction');
            instruction.innerHTML = `üìù <strong>SZERKESZT√âSI M√ìD</strong> - "${zone.name}" z√≥na m√≥dos√≠t√°sa. Rajzolj √∫j ter√ºletet!`;
            instruction.style.display = 'block';
            instruction.style.background = '#fff3cd';
            instruction.style.borderColor = '#ff9800';
        }
        
        // Monitoring
        async function startMonitoring() {
            try {
                const response = await fetch('/api/monitoring/start', {method: 'POST'});
                const data = await response.json();
                if (data.success) {
                    updateMonitorStatus(true);
                    alert('‚úÖ ' + data.message);
                }
            } catch (error) {
                alert('‚ùå Hiba: ' + error);
            }
        }
        
        async function stopMonitoring() {
            try {
                const response = await fetch('/api/monitoring/stop', {method: 'POST'});
                const data = await response.json();
                if (data.success) {
                    updateMonitorStatus(false);
                    alert('‚úÖ ' + data.message);
                }
            } catch (error) {
                alert('‚ùå Hiba: ' + error);
            }
        }
        
        function updateMonitorStatus(isActive) {
            const status = document.getElementById('monitorStatus');
            if (isActive) {
                status.innerHTML = '<span style="color: #38ef7d;">‚óè Fut</span>';
            } else {
                status.innerHTML = '<span style="color: #f85032;">‚óè Le√°ll√≠tva</span>';
            }
        }
        
        async function refreshStates() {
            try {
                // √Ållapotok lek√©r√©se
                const statesResponse = await fetch('/api/states');
                const states = await statesResponse.json();
                
                // Z√≥n√°k lek√©r√©se (friss√≠tett adatokkal)
                const zonesResponse = await fetch('/api/zones');
                zones = await zonesResponse.json();
                
                const display = document.getElementById('statesDisplay');
                display.innerHTML = '';
                
                zones.forEach(zone => {
                    const state = states[zone.id];
                    const card = document.createElement('div');
                    card.className = 'zone-card' + (state ? ' active' : '');
                    
                    // LED t√≠pus nevei
                    const ledTypeNames = {
                        'auto': 'üî¥ Auto',
                        'red': 'üî¥ V√∂r√∂s',
                        'white': '‚ö™ Feh√©r',
                        'green': 'üü¢ Z√∂ld',
                        'blue': 'üîµ K√©k',
                        'orange': 'üü† Narancs',
                        'any': 'üåà B√°rmely'
                    };
                    
                    card.innerHTML = `
                        <div class="status-indicator ${state ? 'on' : 'off'}"></div>
                        <h3>${zone.name}</h3>
                        <div class="zone-info">üí° LED: ${ledTypeNames[zone.led_type] || ledTypeNames['auto']}</div>
                        <div class="zone-info">üéöÔ∏è K√ºsz√∂b: ${zone.threshold}</div>
                        <div class="zone-info">√Ållapot: <strong style="font-size: 1.2em;">${state ? 'üü¢ BEKAPCSOLVA' : '‚ö´ KIKAPCSOLVA'}</strong></div>
                        <div class="zone-info">F√©nyer≈ë: <strong>${zone.last_brightness !== undefined ? zone.last_brightness.toFixed(1) : 'N/A'}</strong></div>
                        <div class="zone-info">Utols√≥: ${zone.last_check ? new Date(zone.last_check).toLocaleTimeString('hu-HU') : 'N/A'}</div>
                    `;
                    display.appendChild(card);
                });
                
                // MQTT st√°tusz
                updateMQTTStatus();
            } catch (error) {
                console.error('√Ållapot friss√≠t√©si hiba:', error);
            }
        }
        
        function updateMQTTStatus() {
            // Ez egy placeholder - a val√≥s MQTT st√°tuszt a backenddel kellene kommunik√°lni
            const status = document.getElementById('mqttStatus');
            status.textContent = 'Csatlakozva';
            status.className = 'mqtt-status connected';
        }
    </script>
</body>
</html>
